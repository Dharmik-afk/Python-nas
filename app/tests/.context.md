# Testing Context: Pytest & Quality Gates

## 1. Testing Framework
- **Tool**: Pytest.
- **Location**: `app/tests/`.
- **Async Tests**: Use `pytest-asyncio` or `anyio` for FastAPI route testing.
- **Multi-Runtime**: All tests MUST pass on both CPython and PyPy. Use `USE_PYPY=true` to toggle runtimes during verification.

## 2. Methodology
- **TDD**: Write failing tests before implementation.
- **Coverage**: Target >80% code coverage for new features.
- **Isolation**: Mock external dependencies (e.g., Copyparty) using `pytest-mock` or `unittest.mock`.
- **Interpreter Awareness**: Tests for process management (Supervisor) must verify `sys.executable` propagation.

## 3. Verification Protocol
- **CI-Aware**: Prefer non-interactive commands.
- **Phase Checkpoints**: All phases MUST end with a verification task and a checkpoint commit.
- **Manual Verification**: Supplement automated tests with clear, step-by-step manual checks.
