<div x-data="galleryHandler()" 
     @open-preview.window="open($event.detail.path)"
     @keydown.escape.window="close()"
     @keydown.left.window="prev()"
     @keydown.right.window="next()"
     @keydown.i.window="toggleDetails()"
     class="lightbox-root">

    <!-- Lightbox Overlay -->
    <template x-if="isOpen">
        <div class="lightbox-overlay" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100">
            
            <!-- Toolbar -->
            <div class="lightbox-toolbar">
                <div class="d-flex align-items-center">
                    <button @click="close()" class="btn-glass me-3">
                        <i class="bi bi-arrow-left"></i>
                    </button>
                    <div class="d-none d-sm-block">
                        <h6 class="mb-0 fw-bold text-truncate" x-text="currentItem?.name" style="max-width: 300px;"></h6>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button @click="toggleDetails()" class="btn-glass" title="Details (i)">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button @click="copyLink()" class="btn-glass" title="Share">
                        <i class="bi bi-share"></i>
                    </button>
                    <a :href="currentItem?.url" download class="btn-glass" title="Download">
                        <i class="bi bi-download"></i>
                    </a>
                </div>
            </div>

            <!-- Content Area -->
            <div class="lightbox-content" 
                 @click.self="close()"
                 @touchstart="touchStartX = $event.changedTouches[0].screenX; touchStartY = $event.changedTouches[0].screenY"
                 @touchend="handleSwipe($event.changedTouches[0].screenX, $event.changedTouches[0].screenY)">
                
                <!-- Loading Spinner -->
                <div x-show="isLoading" class="position-absolute top-50 start-50 translate-middle z-index-2010">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <!-- Prev Button -->
                <button @click="prev()" class="lightbox-nav prev" x-show="items.length > 1">
                    <i class="bi bi-chevron-left"></i>
                </button>

                <!-- Media Display Container -->
                <div class="w-100 h-100 d-flex align-items-center justify-content-center" x-show="!isLoading" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100">
                    <!-- Image -->
                    <template x-if="currentItem?.type === 'image'">
                        <img :src="currentItem.url + '?media'" @load="isLoading = false" class="lightbox-media" :alt="currentItem.name">
                    </template>

                    <!-- Video -->
                    <template x-if="currentItem?.type === 'video'">
                        <video :src="currentItem.url + '?media'" @loadeddata="isLoading = false" controls autoplay class="lightbox-media"></video>
                    </template>

                    <!-- Text/Code -->
                    <template x-if="currentItem?.type === 'text'">
                        <div class="text-preview-container w-100 h-100 overflow-auto shadow-lg" style="max-width: 900px; max-height: 80vh;">
                            <pre class="m-0 small" x-text="textContent"></pre>
                        </div>
                    </template>
                </div>

                <!-- Next Button -->
                <button @click="next()" class="lightbox-nav next" x-show="items.length > 1">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Bottom Sheet (Details) -->
            <div class="bottom-sheet" :class="{ 'show': showDetails }" @click.away="showDetails = false">
                <div class="sheet-handle" @click="showDetails = false"></div>
                <h5 class="mb-4 fw-bold">Details</h5>
                
                <div class="detail-item">
                    <div class="detail-icon"><i class="bi bi-file-earmark"></i></div>
                    <div>
                        <div class="small text-white-50">Filename</div>
                        <div class="fw-medium" x-text="currentItem?.name"></div>
                    </div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="bi bi-hdd"></i></div>
                    <div>
                        <div class="small text-white-50">Size</div>
                        <div class="fw-medium" x-text="currentItem?.size"></div>
                    </div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="bi bi-calendar3"></i></div>
                    <div>
                        <div class="small text-white-50">Date</div>
                        <div class="fw-medium" x-text="currentItem?.mtime"></div>
                    </div>
                </div>

                <template x-if="currentItem?.type === 'image' || currentItem?.type === 'video'">
                    <div class="detail-item">
                        <div class="detail-icon"><i class="bi bi-aspect-ratio"></i></div>
                        <div>
                            <div class="small text-white-50">Type</div>
                            <div class="fw-medium text-capitalize" x-text="currentItem?.type"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </template>
</div>

<script>
function galleryHandler() {
    return {
        isOpen: false,
        isLoading: false,
        showDetails: false,
        items: [],
        currentIndex: 0,
        touchStartX: 0,
        touchStartY: 0,
        textContent: '',
        get currentItem() {
            return this.items[this.currentIndex] || null;
        },
        async open(path) {
            // Encode the path for the API request
            const encodedPath = encodeURIComponent(path);
            
            this.isOpen = true;
            this.isLoading = true;
            this.showDetails = false;
            this.items = [];
            this.currentIndex = 0;
            this.textContent = '';
            
            try {
                const response = await fetch(`/api/v1/gallery/${encodedPath}`);
                if (!response.ok) throw new Error("Gallery API failed");
                
                const data = await response.json();
                this.items = data.items;
                
                // Find index using absolute comparison
                this.currentIndex = this.items.findIndex(item => item.path === path);
                if (this.currentIndex === -1) this.currentIndex = 0;
                
                if (this.currentItem?.type === 'text') {
                    await this.loadText();
                }

                document.body.style.overflow = 'hidden';
                this.prefetchAdjacent();
            } catch (e) {
                console.error("Failed to load gallery info", e);
                // Don't close or redirect automatically, just show the specific item if possible
                this.isLoading = false;
                this.textContent = "Error: Could not load gallery metadata. Direct preview failed.";
            }
        },
        close() {
            this.isOpen = false;
            this.showDetails = false;
            document.body.style.overflow = '';
            this.textContent = '';
        },
        toggleDetails() {
            this.showDetails = !this.showDetails;
        },
        async next() {
            if (this.items.length === 0) return;
            this.isLoading = true;
            this.showDetails = false;
            this.currentIndex = (this.currentIndex + 1) % this.items.length;
            if (this.currentItem?.type === 'text') {
                await this.loadText();
            }
            this.prefetchAdjacent();
        },
        async prev() {
            if (this.items.length === 0) return;
            this.isLoading = true;
            this.showDetails = false;
            this.currentIndex = (this.currentIndex - 1 + this.items.length) % this.items.length;
            if (this.currentItem?.type === 'text') {
                await this.loadText();
            }
            this.prefetchAdjacent();
        },
        async loadText() {
            try {
                const res = await fetch(this.currentItem.url);
                this.textContent = await res.text();
                this.isLoading = false;
            } catch (e) {
                this.textContent = "Error loading text content.";
                this.isLoading = false;
            }
        },
        prefetchAdjacent() {
            if (this.items.length <= 1) return;
            
            // Calculate next and previous indices
            const nextIndex = (this.currentIndex + 1) % this.items.length;
            const prevIndex = (this.currentIndex - 1 + this.items.length) % this.items.length;
            
            [nextIndex, prevIndex].forEach(index => {
                const item = this.items[index];
                if (!item || item.type === 'text') return;

                let prefetchUrl = item.url;
                if (item.type === 'video') {
                    // Only prefetch thumbnails for videos to save bandwidth
                    prefetchUrl += '?thumb=400';
                } else if (item.type === 'image') {
                    // Prefetch full media for images
                    prefetchUrl += '?media';
                }

                // Use fetch with low priority to populate Service Worker cache
                fetch(prefetchUrl, { priority: 'low' }).catch(() => {});
            });
        },
        handleSwipe(endX) {
            const threshold = 50;
            if (this.touchStartX - endX > threshold) {
                this.next();
            } else if (endX - this.touchStartX > threshold) {
                this.prev();
            }
        },
        async copyLink() {
            if (!this.currentItem) return;
            const url = window.location.origin + this.currentItem.url;
            this.copyToClipboard(url, "Link copied to clipboard!");
        },
        async copyToClipboard(text, message = "Copied to clipboard!") {
            try {
                await navigator.clipboard.writeText(text);
                // Simple toast or alert fallback
                alert(message);
            } catch (err) {
                console.error('Failed to copy: ', err);
            }
        }
    }
}
</script>
