{% for item in contents %}
    {% set rel_path = (path.strip('/') + '/' + item.name) if path.strip('/') else item.name %}
    {% set is_previewable = item.is_file() and item.suffix.lower() in ('.png', '.jpg', '.jpeg', '.gif', '.webp', '.svg', '.ico', '.bmp', '.mp4', '.mkv', '.webm', '.avi', '.mov', '.3gp', '.3g2', '.txt', '.md', '.py', '.js', '.html', '.css', '.json', '.yml', '.yaml', '.xml', '.sh', '.sql', '.log', '.ini', '.conf', '.bat', '.bash') %}
    <div class="col animate fade-in" style="animation-delay: {{ loop.index0 * 0.05 }}s">
        <div class="card h-100 glass-card file-card position-relative border-0 shadow-sm"
             {% if item.is_dir() %}
             hx-get="/{{ rel_path }}" 
             hx-target="#main-content" 
             hx-push-url="true"
             {% elif is_previewable %}
             @click.stop="$dispatch('open-preview', { path: '{{ rel_path }}' })"
             {% else %}
             @click="window.location.href='/download/{{ rel_path }}'"
             {% endif %}>
            
            <div class="card-body d-flex flex-column align-items-center justify-content-center p-4">
                <div class="icon-wrapper mb-3">
                    {% if item.is_dir() %}
                        <img src="/static/icons/folder.svg" alt="Folder" class="main-icon">
                    {% else %}
                        {% set ext = item.name.split('.')[-1].lower() if '.' in item.name else 'default' %}
                        <img src="/static/icons/{{ ext }}.svg" alt="{{ ext }}" class="main-icon" onerror="this.src='/static/icons/default.svg'">
                    {% endif %}
                    
                    {% if not item.is_dir() %}
                        <div class="file-badge">{{ ext|upper if ext else 'FILE' }}</div>
                    {% endif %}
                </div>

                <div class="text-center w-100">
                    <h6 class="file-title mb-0 text-break" title="{{ item.name }}">{{ item.name }}</h6>
                </div>
            </div>

            <!-- Hover Action Overlay -->
            <div class="card-overlay d-flex gap-2">
                {% if not item.is_dir() %}
                <a href="/download/{{ rel_path }}" class="action-btn" title="Download" @click.stop>
                    <i class="bi bi-download"></i>
                </a>
                {% endif %}
                
                {% if 'd' in pmask %}
                <button class="delete-btn" title="Delete"
                        @click.stop="if(confirm('Are you sure you want to delete {{ item.name }}?')) { $el.closest('.col').remove(); htmx.ajax('DELETE', '/api/v1/fs/{{ rel_path|urlencode }}', {swap:'none'}) }">
                    <i class="bi bi-trash-fill"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>
{% endfor %}

{% if not contents %}
    <div class="col-12 animate zoom-in">
        <div class="empty-state text-center py-5 glass-card">
            <div class="empty-icon-bg mb-4">
                <i class="bi bi-folder2-open display-3 text-white-50"></i>
            </div>
            <h4 class="fw-bold">No items found</h4>
            <p class="text-white-50">This directory seems to be empty.</p>
        </div>
    </div>
{% endif %}
