{% extends "layouts/base.html" %}

{% block content %}
<div class="file-browser animate slide-in" hx-ext="class-tools">
    <!-- New Account Section -->
    <div class="account-status-banner mb-4 p-3 glass-card d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-3">
            <div class="user-avatar-glow">
                <i class="bi bi-person-circle"></i>
            </div>
            <div>
                <div class="text-white-50 small text-uppercase fw-bold letter-spacing-1">Current User</div>
                <h5 class="mb-0 fw-black text-white">
                    {% if username %}
                        {{ username }} <span class="badge rounded-pill bg-glass-secondary ms-2 small fw-normal">{{ user_permissions }}</span>
                    {% else %}
                        Unregistered
                    {% endif %}
                </h5>
            </div>
        </div>
        {% if not username %}
        <a href="/login" class="btn btn-sm btn-glass-primary rounded-pill px-4">
            <i class="bi bi-box-arrow-in-right me-1"></i> LOGIN
        </a>
        {% else %}
        <div class="status-badge online">
            <span class="dot"></span> ONLINE
        </div>
        {% endif %}
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-5 gap-4">
        <nav aria-label="breadcrumb" class="glass-breadcrumb-container flex-grow-1 px-4 py-2">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="/" class="home-link" hx-get="/" hx-target="#main-content" hx-push-url="true">
                        <i class="bi bi-house-door-fill"></i>
                    </a>
                </li>
                {% set parts = path.strip('/').split('/') %}
                {% set current_path = namespace(value='') %}
                {% for part in parts %}
                    {% if part %}
                        {% set current_path.value = current_path.value + '/' + part %}
                        {% if loop.last %}
                            <li class="breadcrumb-item active text-white fw-bold" aria-current="page">{{ part }}</li>
                        {% else %}
                            <li class="breadcrumb-item">
                                <a href="{{ current_path.value }}" 
                                   hx-get="{{ current_path.value }}" 
                                   hx-target="#main-content" 
                                   hx-push-url="true">{{ part }}</a>
                            </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>

        <div class="d-flex gap-2">
            {% if 'w' in pmask %}
            <button class="btn btn-glass-secondary rounded-pill px-4 py-2 d-flex align-items-center gap-2 shadow-lg"
                    @click="const name = prompt('Enter folder name:'); if(name) { htmx.ajax('POST', '/api/v1/fs/mkdir/{{ (path.strip('/') + '/') if path.strip('/') else '' }}' + encodeURIComponent(name), {target: '#file-list', swap: 'innerHTML'}) }">
                <i class="bi bi-folder-plus fs-5"></i>
                <span class="fw-bold small d-none d-md-inline">CREATE FOLDER</span>
            </button>

            <form id="upload-form" hx-encoding="multipart/form-data" hx-post="/upload/{{ path.strip('/') }}" hx-target="#file-list" hx-swap="innerHTML">
                <label class="btn-modern-primary rounded-pill px-4 py-2 d-flex align-items-center gap-2 cursor-pointer shadow-lg">
                    <i class="bi bi-cloud-arrow-up-fill fs-5"></i>
                    <span class="fw-bold small d-none d-md-inline">UPLOAD FILES</span>
                    <input type="file" name="files" multiple style="display: none;" onchange="htmx.trigger(this.form, 'submit')">
                </label>
            </form>
            {% endif %}
        </div>
    </div>

    <!-- Search Section -->
    <div class="row mb-4">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="glass-card p-1 rounded-pill d-flex align-items-center px-3">
                <i class="bi bi-search text-white-50 me-2"></i>
                <input type="text" name="q" 
                       class="form-control bg-transparent border-0 text-white shadow-none" 
                       placeholder="Search files..."
                       hx-get="/api/v1/fs/search/ui"
                       hx-include="[name='path']"
                       hx-trigger="keyup changed delay:500ms, search"
                       hx-target="#file-list"
                       hx-indicator=".search-indicator">
                <input type="hidden" name="path" value="{{ path }}">
                <div class="search-indicator htmx-indicator spinner-border spinner-border-sm text-primary ms-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="file-list" class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-4">
        {% include "partials/file_browser_content.html" %}
    </div>
</div>
{% endblock %}
