# Backend Context: FastAPI & SQLAlchemy

## 1. Architecture
- **Framework**: FastAPI (Single-port 8000 gateway).
- **Runtime**: Supports both CPython 3.12 (Standard) and PyPy 3.11+ (High-Performance Mode).
- **ORM**: SQLAlchemy with SQLite (`storage/db/server.db`).
- **Migrations**: Alembic (`alembic/versions`).
- **Pydantic**: Used for request/response schemas and settings validation.

## 2. Implementation Guidelines
- **Routes**: Located in `app/backend/routes/`.
- **CRUD**: Business logic and DB interactions go in `app/backend/database/crud.py`.
- **Services**: External service integrations (like Copyparty) go in `app/backend/services/`.
- **Async**: Prefer `async def` for route handlers. Use `run_in_threadpool` for blocking I/O if necessary.
- **PyPy Optimization**: Internal timeouts for service handshakes (e.g., `verify_with_copyparty`) are increased (15s) to accommodate PyPy JIT warm-up.

## 3. Security
- **Middleware**: Auth middleware is enforced at the FastAPI level.
- **Reference**: See role overlay `.context/security.md` for jail confinement rules.
